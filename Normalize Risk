-- homeowners vs. non-homeowners; normalized by homeowners risk grade
WITH NORMALIZER AS (
    SELECT 
        HOMEOWNER, 
        RSK_LVL,
        COUNT(DISTINCT CASE WHEN MOB_THREADED = 0 AND ACCT_STATUS = 'A' THEN ACCT_KEY END) AS ORIG_CT,
        ORIG_CT/SUM(ORIG_CT) OVER () AS DISTRO,
        SUM(CASE WHEN MOB_THREADED = 0 AND ACCT_STATUS = 'A' THEN NEW_MONEY END) AS ORIG_NM,
        ORIG_NM / SUM(ORIG_NM) OVER () AS DISTRO_NM
    FROM PERF_DRIVER
    WHERE HOMEOWNER = 'H' AND LOAN_TYPE = 'Unsecured'
    GROUP BY 1, 2
),
RISK AS (
    SELECT
        HOMEOWNER,
        RSK_LVL,
        MOB_THREADED,
        COUNT(DISTINCT CASE WHEN MOB_THREADED = 0 AND ACCT_STATUS = 'A' THEN ACCT_KEY END) AS ORIG_CT,
        SUM(ORIG_CT) OVER (PARTITION BY HOMEOWNER, RSK_LVL ORDER BY MOB_THREADED ASC) AS ORIG_CT2,
        SUM(SUM(CASE WHEN MOB_THREADED = 0 AND ACCT_STATUS = 'A' THEN NEW_MONEY END)) OVER (PARTITION BY HOMEOWNER, RSK_LVL ORDER BY MOB_THREADED ASC) AS ORIG_NM,
        COUNT(DISTINCT CASE WHEN CO_EVER_IND = 1 THEN ACCT_KEY END) / ORIG_CT2 AS CUMU_CO_PER_ORIG,
        SUM(CASE WHEN CO_EVER_IND = 1 THEN CO_AMT_CUMU END) / ORIG_NM AS CUMU_CO$_PER_ORIG_NM
    FROM (
        SELECT
            ACCT_KEY,
            MOB_THREADED,
            ACCT_STATUS,
            HOMEOWNER,
            RSK_LVL,
            NEW_MONEY,
            CASE WHEN DLQ_GROUP = '88' THEN 1 ELSE 0 END AS CO_IND,
            CASE WHEN SUM(CO_IND) OVER (PARTITION BY ACCT_KEY ORDER BY MOB_THREADED ASC) > 0 THEN 1 ELSE 0 END AS CO_EVER_IND,
            SUM(AMT_CHGOFF) OVER (PARTITION BY ACCT_KEY ORDER BY MOB_THREADED ASC) AS CO_AMT_CUMU
        FROM PERF_DRIVER
        WHERE LOAN_TYPE = 'Unsecured'
    ) 
    GROUP BY 1, 2, 3 
    ORDER BY 1, 2, 3
)
SELECT A.HOMEOWNER, MOB_THREADED, SUM(CUMU_CO_PER_ORIG * DISTRO) / SUM(DISTRO) AS CO_PER_ORIG_NORMALIZED, SUM(CUMU_CO$_PER_ORIG_NM * DISTRO_NM) / SUM(DISTRO_NM) AS CUMU_CO$_PER_ORIG_NM_NORMALIZED
FROM RISK A
LEFT JOIN NORMALIZER B ON A.RSK_LVL = B.RSK_LVL
GROUP BY 1, 2
ORDER BY 1, 2;
