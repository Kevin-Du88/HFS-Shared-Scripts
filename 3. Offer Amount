// % with & without cars
SELECT 
    --RSK_LVL,
    COUNT(DISTINCT CASE WHEN COLLAT_VALUE IS NULL THEN APPL_KEY END) / COUNT(DISTINCT APPL_KEY) AS NULL_VEHICLE_RATE,
    COUNT(DISTINCT APPL_KEY) AS TOTAL_CT
FROM DRIVER_FINAL
WHERE 1 = 1
AND OFFER_TYPE IN ('multi offer', 'SDL', 'sec only')
AND (MTA0300 BETWEEN 1 AND 89 OR HOMEOWNER = 'H')
AND RSK_LVL <> 'D'
--GROUP BY 1
--ORDER BY 1
;

// Target waterfall
SELECT
    --CURRENT_OFFER, 
    OFFER_TYPE,
    COUNT(DISTINCT APPL_KEY) * 2 AS OFFER_CT,
    COUNT(DISTINCT CASE WHEN CATEGORY = 'BOOKED' THEN APPL_KEY END) * 2 AS BOOKED,
    COUNT(DISTINCT CASE WHEN CATEGORY = 'RQST GT CAP' THEN APPL_KEY END) * 2 AS RQST_GT_CAP,
    COUNT(DISTINCT CASE WHEN CATEGORY = 'MET RQST AMT' THEN APPL_KEY END) * 2 AS MET_RQST_AMT,
    COUNT(DISTINCT CASE WHEN CATEGORY = 'NON HO' THEN APPL_KEY END) * 2 AS NON_HO,
    OFFER_CT - BOOKED - RQST_GT_CAP - MET_RQST_AMT - NON_HO AS TARGET_1,
    COUNT(DISTINCT CASE WHEN CATEGORY = 'WITH VEHICLE INFO' THEN APPL_KEY END) * 2 AS VEHICLE_PROVIDE,
    TARGET_1 - VEHICLE_PROVIDE AS TARGET_2
FROM (
    SELECT
        APPL_KEY,
        OFFER_TYPE,
        CURRENT_OFFER,
        HFS_INCR_TARGET,
        HFS_INCR_TARGET_CUR,
        HFS_UNSEC_TARGET,
        HFS_UNSEC_TARGET_CUR,
        CASE
            WHEN ACCT_KEY > 0 THEN 'BOOKED'
            WHEN (RSK_LVL IN ('S', 'P', 'A' ) AND CRDT_LMT_RQST_AM > 20000) OR (RSK_LVL = 'B' AND CRDT_LMT_RQST_AM > 15000) OR (RSK_LVL = 'C' AND CRDT_LMT_RQST_AM > 12000) THEN 'RQST GT CAP'
            WHEN CRDT_LMT_RQST_AM <= (FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)) OR CRDT_LMT_RQST_AM <= UNSEC_OFFER_AMT THEN 'MET RQST AMT'
            WHEN MTA0300 NOT BETWEEN 1 AND 89 AND HOMEOWNER <> 'H' THEN 'NON HO'
            WHEN COLLAT_VALUE IS NOT NULL THEN 'WITH VEHICLE INFO'
            END AS CATEGORY
    FROM DRIVER_FINAL
    WHERE --CURRENT_OFFER IN ('MO', 'SDL', 'SO') 
    OFFER_TYPE IN ('multi offer', 'SDL', 'sec only')
) 
GROUP BY 1--, 2 
ORDER BY 1--, 2
;

-- PTR by request - CO diff
SELECT
    CASE
        WHEN CRDT_LMT_RQST_AM <= (FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)) THEN '1. Request amt met by CO'
        WHEN CRDT_LMT_RQST_AM - (FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)) <= 5000 THEN '2. Request amt - CO $0-5K'
        WHEN CRDT_LMT_RQST_AM - (FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)) <= 10000 THEN '3. Request amt - CO $5-10K'
        WHEN CRDT_LMT_RQST_AM - (FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)) > 10000 THEN '4. Request amt - CO $10K+'
        END AS RQST_CO_DIFF_BKT,
    COUNT(DISTINCT APPL_KEY) AS CT,
    RATIO_TO_REPORT(CT) OVER () AS PERC,
    COUNT(DISTINCT CASE WHEN ACCT_KEY > 0 AND LOAN_TYPE = 'Secured' THEN APPL_KEY END) / CT AS PTR
FROM DRIVER_FINAL
WHERE 1 = 1
AND OFFER_TYPE = 'sec only'
AND (MTA0300 BETWEEN 1 AND 89 OR HOMEOWNER = 'H')
--AND FINAL_SECURED_OFFER > 0
--AND COLLAT_VALUE IS NOT NULL
GROUP BY 1 ORDER BY 1
;

SELECT OFFER_TYPE, COUNT(DISTINCT CASE WHEN ACCT_KEY > 0 AND LOAN_TYPE = 'Secured' THEN APPL_KEY END) / COUNT(DISTINCT APPL_KEY) AS PTR FROM DRIVER_FINAL WHERE OFFER_TYPE IN ('multi offer', 'SDL', 'sec only') GROUP BY 1;


// BAU auto secured loan amount distros
SELECT
    -- RSK_LVL,
    CASE
        WHEN FINAL_SECURED_OFFER <= 5000 THEN '1. $0-5K'
        WHEN FINAL_SECURED_OFFER <= 10000 THEN '2. $5-10K' 
        WHEN FINAL_SECURED_OFFER <= 15000 THEN '3. $10-15K' 
        WHEN FINAL_SECURED_OFFER <= 20000 THEN '4. $15-20K' 
        WHEN FINAL_SECURED_OFFER <= 25000 THEN '5. $20K-25K'
        WHEN FINAL_SECURED_OFFER > 25000 THEN '5. $25K+'
        END AS SEC_AMT_BKT,
    -- CASE
    --     WHEN FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE) <= 0 THEN '0. $0 or below'
    --     WHEN FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE) <= 5000 THEN '1. $0-5K'
    --     WHEN FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE) <= 10000 THEN '2. $5-10K'
    --     WHEN FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE) <= 15000 THEN '3. $15-20K'
    --     WHEN FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE) <= 20000 THEN '4. $15-20K'
    --     WHEN FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE) > 20000 THEN '5. $20K+'
    --     END AS COSEC_AMT_BKT,
    --COUNT(DISTINCT CASE WHEN FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE) < UNSEC_OFFER_AMT THEN APPL_KEY END) AS CO_BELOW_UNSEC_CT,
    COUNT(DISTINCT APPL_KEY) AS APP_CT,
    RATIO_TO_REPORT(APP_CT) OVER (/*PARTITION BY RSK_LVL*/) AS PERC,
    AVG(FINAL_SECURED_OFFER) AS AVG_SEC_AMT
FROM DRIVER_FINAL
WHERE 1 = 1
AND OFFER_TYPE IN ('multi offer', 'SDL', 'sec only')
AND COLLAT_VALUE IS NOT NULL
AND FINAL_SECURED_OFFER > 0 
AND (MTA0300 BETWEEN 1 AND 89 OR HOMEOWNER = 'H')
GROUP BY 1--, 2
ORDER BY 1--, 2
;

// Aligning HFS offer amount with full secured offer may cannibalize auto secured volume but improve our portfolio mix as we attract homeowners
-- Waterfall: BAU AS volume, minus homeowners, remaining volume
SELECT
    COUNT(DISTINCT APPL_KEY) * 2 AS BAU_AS_VOL,
    COUNT(DISTINCT CASE WHEN (MTA0300 BETWEEN 1 AND 89 OR HOMEOWNER = 'H') THEN APPL_KEY END) * 2 AS BAU_HO_VOL,
    BAU_AS_VOL - BAU_HO_VOL AS REMAINING_AS_VOL
FROM DRIVER_FINAL
WHERE 1 = 1
AND OFFER_TYPE IN ('multi offer', 'SDL', 'sec only')
AND ACCT_KEY > 0
AND LOAN_TYPE = 'Secured';

-- Waterfall; BAU %HO in book, plus more HO (apps with CO < requested), new %HO (full AS cannibalization)
SELECT
    COUNT(DISTINCT CASE WHEN ACCT_KEY > 0 AND LOAN_TYPE = 'Secured' THEN APPL_KEY END) * 2 AS BAU_SEC_CT,
    COUNT(DISTINCT CASE WHEN ACCT_KEY > 0 AND LOAN_TYPE = 'Secured' AND (MTA0300 BETWEEN 1 AND 89 OR HOMEOWNER = 'H') THEN APPL_KEY END) * 2 AS BAU_SEC_HO_CT,
    COUNT(DISTINCT CASE WHEN HFS_INCR_TARGET = 1 THEN APPL_KEY END) * 2 * 0.1 AS INCR_HO_CT,
    BAU_SEC_HO_CT + INCR_HO_CT AS NEW_HO_CT,
    BAU_SEC_CT + INCR_HO_CT AS NEW_CT
FROM DRIVER_FINAL
WHERE 1 = 1
AND OFFER_TYPE IN ('multi offer', 'SDL', 'sec only')
;

// Reduced portfolio risk from booking more homeowners could offset the secondary risk of granting more exposure
-- homeowners vs. non-homeowners; normalized by homeowners risk grade
WITH NORMALIZER AS (
    SELECT 
        HOMEOWNER, 
        RSK_LVL,
        COUNT(DISTINCT CASE WHEN MOB_THREADED = 0 AND ACCT_STATUS = 'A' THEN ACCT_KEY END) AS ORIG_CT,
        ORIG_CT/SUM(ORIG_CT) OVER () AS DISTRO,
        SUM(CASE WHEN MOB_THREADED = 0 AND ACCT_STATUS = 'A' THEN NEW_MONEY END) AS ORIG_NM,
        ORIG_NM / SUM(ORIG_NM) OVER () AS DISTRO_NM
    FROM PERF_DRIVER
    WHERE HOMEOWNER = 'H' AND LOAN_TYPE = 'Unsecured'
    GROUP BY 1, 2
),
RISK AS (
    SELECT
        HOMEOWNER,
        RSK_LVL,
        MOB_THREADED,
        COUNT(DISTINCT CASE WHEN MOB_THREADED = 0 AND ACCT_STATUS = 'A' THEN ACCT_KEY END) AS ORIG_CT,
        SUM(ORIG_CT) OVER (PARTITION BY HOMEOWNER, RSK_LVL ORDER BY MOB_THREADED ASC) AS ORIG_CT2,
        SUM(SUM(CASE WHEN MOB_THREADED = 0 AND ACCT_STATUS = 'A' THEN NEW_MONEY END)) OVER (PARTITION BY HOMEOWNER, RSK_LVL ORDER BY MOB_THREADED ASC) AS ORIG_NM,
        COUNT(DISTINCT CASE WHEN CO_EVER_IND = 1 THEN ACCT_KEY END) / ORIG_CT2 AS CUMU_CO_PER_ORIG,
        SUM(CASE WHEN CO_EVER_IND = 1 THEN CO_AMT_CUMU END) / ORIG_NM AS CUMU_CO$_PER_ORIG_NM
    FROM (
        SELECT
            ACCT_KEY,
            MOB_THREADED,
            ACCT_STATUS,
            HOMEOWNER,
            RSK_LVL,
            NEW_MONEY,
            CASE WHEN DLQ_GROUP = '88' THEN 1 ELSE 0 END AS CO_IND,
            CASE WHEN SUM(CO_IND) OVER (PARTITION BY ACCT_KEY ORDER BY MOB_THREADED ASC) > 0 THEN 1 ELSE 0 END AS CO_EVER_IND,
            SUM(AMT_CHGOFF) OVER (PARTITION BY ACCT_KEY ORDER BY MOB_THREADED ASC) AS CO_AMT_CUMU
        FROM PERF_DRIVER
        WHERE LOAN_TYPE = 'Unsecured'
    ) 
    GROUP BY 1, 2, 3 
    ORDER BY 1, 2, 3
)
SELECT A.HOMEOWNER, MOB_THREADED, SUM(CUMU_CO_PER_ORIG * DISTRO) / SUM(DISTRO) AS CO_PER_ORIG_NORMALIZED, SUM(CUMU_CO$_PER_ORIG_NM * DISTRO_NM) / SUM(DISTRO_NM) AS CUMU_CO$_PER_ORIG_NM_NORMALIZED
FROM RISK A
LEFT JOIN NORMALIZER B ON A.RSK_LVL = B.RSK_LVL
GROUP BY 1, 2
ORDER BY 1, 2
;


-- Portfolio mix (Uns vs. AS vs. HFS)
SELECT 
    LOAN_TYPE, 
    COUNT(DISTINCT CASE WHEN ACCT_KEY > 0 THEN APPL_KEY END) * 2 AS CURRENT_CT, 
    COUNT(DISTINCT CASE WHEN HFS_INCR_TARGET = 1 AND COLLAT_VALUE IS NOT NULL THEN APPL_KEY END) * 2 * 0.1 AS HFS_INCR_HAS_VEHICLE,
    COUNT(DISTINCT CASE WHEN OFFER_TYPE = 'multi offer' AND HFS_UNSEC_TARGET = 1 AND COLLAT_VALUE IS NOT NULL THEN APPL_KEY END) * 2 * 0.27 AS HFS_UNS_MO_CONV_HAS_VEHICLE,
    COUNT(DISTINCT CASE WHEN OFFER_TYPE = 'SDL' AND HFS_UNSEC_TARGET = 1 AND COLLAT_VALUE IS NOT NULL THEN APPL_KEY END) * 2 * 0.65 AS HFS_UNS_SDL_CONV_HAS_VEHICLE,
    COUNT(DISTINCT CASE WHEN HFS_INCR_TARGET = 1 AND COLLAT_VALUE IS NULL THEN APPL_KEY END) * 2 * 0.05 AS HFS_INCR_NO_VEHICLE,
    COUNT(DISTINCT CASE WHEN OFFER_TYPE = 'multi offer' AND HFS_UNSEC_TARGET = 1 AND COLLAT_VALUE IS NULL THEN APPL_KEY END) * 2 * 0.19 AS HFS_UNS_MO_NO_VEHICLE,
    COUNT(DISTINCT CASE WHEN OFFER_TYPE = 'SDL' AND HFS_UNSEC_TARGET = 1 AND COLLAT_VALUE IS NULL THEN APPL_KEY END) * 2 * 0.45 AS HFS_UNS_SDL_NO_VEHICLE
FROM DRIVER_FINAL
WHERE 1 = 1
AND OFFER_TYPE IN ('multi offer', 'SDL', 'sec only')
GROUP BY 1 ORDER BY 1;

SELECT 
    CASE WHEN (MTA0300 BETWEEN 1 AND 89 OR HOMEOWNER = 'H') THEN 1 ELSE 0 END AS HO_IND,
    LOAN_TYPE, 
    SUM(NEW_MONEY) * 2 AS TOTAL_NM,
    SUM(FINAL_SECURED_OFFER) / COUNT(DISTINCT APPL_KEY) AS AVG_SEC_OFFER,
    SUM(UNSEC_OFFER_AMT) / COUNT(DISTINCT APPL_KEY) AS AVG_UNSEC_OFFER,
    SUM(FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)) / COUNT(DISTINCT APPL_KEY) AS AVG_CO,
    COUNT(DISTINCT APPL_KEY) * 2 AS CT
FROM DRIVER_FINAL
WHERE OFFER_TYPE IN ('multi offer', 'SDL', 'sec only') AND ACCT_KEY > 0
GROUP BY 1, 2--, 3
ORDER BY 1, 2--, 3
;

------------------------------------------------------------------------------------------------------

// New logic results

SELECT 
    -- RSK_LVL,
    -- CASE
    --     WHEN PROPOSED_OFFER_AMT <= 5000 THEN '1. $0-5K'
    --     WHEN PROPOSED_OFFER_AMT <= 10000 THEN '2. $5-10K'
    --     WHEN PROPOSED_OFFER_AMT <= 15000 THEN '3. $10-15K'
    --     WHEN PROPOSED_OFFER_AMT <= 20000 THEN '4. $15-20K'
    --     WHEN PROPOSED_OFFER_AMT <= 25000 THEN '5. $20-25K'
    --     WHEN PROPOSED_OFFER_AMT > 25000 THEN '6. $25K+'
    --     END AS PROPOSED_OFFER_AMT_BKT,
    -- CASE
    --     WHEN FINAL_SECURED_OFFER - PROPOSED_OFFER_AMT > 5000 THEN '1. -$5K+'
    --     WHEN FINAL_SECURED_OFFER - PROPOSED_OFFER_AMT > 0 THEN '2. -$0-5K'       
    --     WHEN FINAL_SECURED_OFFER = PROPOSED_OFFER_AMT THEN '3. $0'
    --     WHEN PROPOSED_OFFER_AMT - FINAL_SECURED_OFFER <= 5000 THEN '4. 0-5K'
    --     WHEN PROPOSED_OFFER_AMT - FINAL_SECURED_OFFER <= 10000 THEN '5. 5-10K'
    --     WHEN PROPOSED_OFFER_AMT - FINAL_SECURED_OFFER > 10000 THEN '> $10K'
    --     END AS PROP_VS_BAU_DIFF_BKT,
    -- CASE
    --     WHEN PROPOSED_OFFER_AMT / FINAL_SECURED_OFFER < 0.7 THEN '1. <70%'
    --     WHEN PROPOSED_OFFER_AMT / FINAL_SECURED_OFFER < 1 THEN '2. 70-100%'
    --     WHEN PROPOSED_OFFER_AMT / FINAL_SECURED_OFFER = 1 THEN '3. 100%'
    --     WHEN PROPOSED_OFFER_AMT / FINAL_SECURED_OFFER <= 1.3 THEN '4. 100-130%'
    --     WHEN PROPOSED_OFFER_AMT / FINAL_SECURED_OFFER <= 1.5 THEN '5. 130-150%'
    --     WHEN PROPOSED_OFFER_AMT / FINAL_SECURED_OFFER > 1.5 THEN '6. 150%+'
    --     END AS PROP_VS_BAU_DIFF_BKT,
    -- CASE
    --     WHEN HFS_CASHOUT - (FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)) < 0 THEN '1. AS CO higher' 
    --     -- WHEN HFS_CASHOUT - (FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)) = 0 THEN '2. 0' 
    --     WHEN HFS_CASHOUT - (FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)) <= 5000 THEN '3. 0-5K'
    --     WHEN HFS_CASHOUT - (FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)) <= 10000 THEN '4. 5-10K'
    --     WHEN HFS_CASHOUT - (FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)) <= 15000 THEN '5. 10-15K'
    --     WHEN HFS_CASHOUT - (FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)) > 15000 THEN '6. >15K'
    --     END AS PROP_VS_BAU_CO_DIFF_BKT,
    --CASE WHEN (PROPOSED_OFFER_AMT - FINAL_SECURED_OFFER) / FINAL_SECURED_OFFER > 0.3 THEN '>30%' ELSE '<=30%' END AS DIFF_GT30_BKT,
    --CASE WHEN FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE) < 0 THEN 1 ELSE 0 END AS AS_CO_LT0,
    -- AVG(HFS_CASHOUT)
    COUNT(DISTINCT APPL_KEY) AS APP_CT,
    -- RATIO_TO_REPORT(APP_CT) OVER (PARTITION BY RSK_LVL) AS PERC,
    AVG(PROPOSED_OFFER_AMT) AS AVG_PROPOSED_OFFER_AMT,
    -- AVG(FINAL_SECURED_OFFER) AS AVG_BAU_OFFER_AMT,
    -- AVG(UNSEC_OFFER_AMT) AS AVG_UNSEC_AMT,
    -- AVG(DEBT_VALUE) AS AVG_DEBT_VALUE,
    -- AVG(FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)) AS AVG_COSEC_AMT
FROM (
    SELECT
        APPL_KEY, ACCT_KEY, CURRENT_OFFER, OFFER_TYPE, LOAN_TYPE, RSK_LVL, SM_SEC_OFFER, UNSEC_OFFER_AMT, FINAL_SECURED_OFFER, DEBT_VALUE, COLLAT_VALUE,
        CASE
            WHEN RSK_LVL = 'S' THEN (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER > 30000 THEN 30000 ELSE SM_SEC_OFFER END)
            WHEN RSK_LVL = 'P' THEN (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER > 25000 THEN 25000 ELSE SM_SEC_OFFER END)
            WHEN RSK_LVL = 'A' THEN (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER * 0.9 > 22500 THEN 22500 ELSE SM_SEC_OFFER * 0.9 END)
            WHEN RSK_LVL = 'B' THEN (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER * 0.85 > 15000 THEN 15000 ELSE SM_SEC_OFFER * 0.85 END)
            ELSE (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER * 0.75 > 12000 THEN 12000 ELSE SM_SEC_OFFER * 0.75 END)
            END AS PROPOSED_OFFER_AMT,
        CASE
            WHEN RSK_LVL IN ('S', 'P', 'A') THEN (CASE WHEN PROPOSED_OFFER_AMT > 20000 THEN 20000 ELSE PROPOSED_OFFER_AMT END)
            WHEN RSK_LVL = 'B' THEN (CASE WHEN PROPOSED_OFFER_AMT > 15000 THEN 15000 ELSE PROPOSED_OFFER_AMT END)
            WHEN RSK_LVL = 'C' THEN (CASE WHEN PROPOSED_OFFER_AMT > 12000 THEN 12000 ELSE PROPOSED_OFFER_AMT END)
            END AS HFS_CASHOUT,
        
        // no debt consol
        -- CASE
        --     WHEN RSK_LVL = 'S' THEN (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER > 20000 THEN 20000 ELSE SM_SEC_OFFER END)
        --     WHEN RSK_LVL = 'P' THEN (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER > 20000 THEN 20000 ELSE SM_SEC_OFFER END)
        --     WHEN RSK_LVL = 'A' THEN (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER * 0.9 > 20000 THEN 20000 ELSE SM_SEC_OFFER * 0.9 END)
        --     WHEN RSK_LVL = 'B' THEN (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER * 0.85 > 15000 THEN 15000 ELSE SM_SEC_OFFER * 0.85 END)
        --     ELSE (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER * 0.75 > 12000 THEN 12000 ELSE SM_SEC_OFFER * 0.75 END)
        --     END AS PROPOSED_OFFER_AMT
    FROM DRIVER_FINAL
    WHERE 1 = 1
    AND OFFER_TYPE IN ('multi offer', 'SDL', 'sec only')
    AND (MTA0300 BETWEEN 1 AND 89 OR HOMEOWNER = 'H')
    AND RSK_LVL <> 'D'
    --AND ACCT_KEY > 0 AND LOAN_TYPE = 'Secured'
    --AND COLLAT_VALUE IS NOT NULL AND FINAL_SECURED_OFFER > 0 -- toggle on for comparing differences
    --AND (HFS_INCR_TARGET = 1 OR HFS_UNSEC_TARGET = 1)
)
-- GROUP BY 1, 2
-- ORDER BY 1, 2
;

-- RG S & P skew very heavily HFS > AS --> hypothesis: we don't need to freak out because these people tend to book unsecured
SELECT 
    RSK_LVL, 
    COUNT(DISTINCT APPL_KEY) AS APP_CT, 
    COUNT(DISTINCT CASE WHEN ACCT_KEY > 0 AND LOAN_TYPE = 'Secured' THEN APPL_KEY END) AS SEC_CT, 
    COUNT(DISTINCT CASE WHEN ACCT_KEY > 0 AND LOAN_TYPE = 'Unsecured' THEN APPL_KEY END) AS UNS_CT,
    SEC_CT / APP_CT AS SEC_PTR, 
    UNS_CT / APP_CT AS UNS_PTR
FROM DRIVER_FINAL
WHERE 1 = 1
AND OFFER_TYPE IN ('multi offer', 'SDL', 'sec only')
AND (MTA0300 BETWEEN 1 AND 89 OR HOMEOWNER = 'H')
AND RSK_LVL IN ('S', 'P', 'A', 'B', 'C')
AND COLLAT_VALUE IS NOT NULL AND FINAL_SECURED_OFFER > 0
GROUP BY 1
;

-- % with low NDI
SELECT 
    RSK_LVL,
    CASE WHEN NDI < 500 THEN '1. <500' WHEN NDI < 750 THEN '2. 500-750' WHEN NDI < 1000 THEN '3. 750-1K' WHEN NDI > 1000 THEN '4. >1K' END AS NDI_BKT,
    COUNT(DISTINCT APPL_KEY) AS APP_CT,
    RATIO_TO_REPORT(APP_CT) OVER (PARTITION BY RSK_LVL) AS APP_PERC
FROM DRIVER_FINAL
WHERE 1 = 1
AND OFFER_TYPE IN ('multi offer', 'SDL', 'sec only')
AND (MTA0300 BETWEEN 1 AND 89 OR HOMEOWNER = 'H')
AND RSK_LVL IN ('A', 'B', 'C')
AND ACCT_KEY > 0
--AND COLLAT_VALUE IS NOT NULL AND FINAL_SECURED_OFFER > 0
GROUP BY 1, 2
ORDER BY 1, 2
;

---------------------------------------------------------------------------------
---------------------------------------------------------------------------------
---------------------------------------------------------------------------------

-- Cashout vs. full loan amount analysis

// Cashout amount difference between people who don't book and people who do (on secured)
// % of apps/bookings with cashout below $x, for people who don't book and people who do (on secured)
SELECT
    CASE WHEN ACCT_KEY > 0 THEN LOAN_TYPE ELSE 'Not Booked' END AS BOOKING_IND,
    -- CASE
    --     WHEN FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE) <= 5000 THEN '1. <$5K'
    --     WHEN FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE) <= 10000 THEN '2. $5-10K'
    --     WHEN FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE) <= 15000 THEN '3. $10-15K'
    --     WHEN FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE) <= 20000 THEN '4. $15-20K'
    --     WHEN FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE) > 20000 THEN '6. $20K+'
    --     END AS CASHOUT_AMT_BKT,
    -- CASE
    --     WHEN FINAL_SECURED_OFFER <= 5000 THEN '1. <$5K'
    --     WHEN FINAL_SECURED_OFFER <= 10000 THEN '2. $5-10K'
    --     WHEN FINAL_SECURED_OFFER <= 15000 THEN '3. $10-15K'
    --     WHEN FINAL_SECURED_OFFER <= 20000 THEN '4. $15-20K'
    --     WHEN FINAL_SECURED_OFFER > 20000 THEN '6. $20K+'
    --     END AS FULL_AMT_BKT,
    COUNT(DISTINCT APPL_KEY) AS CT,
    -- RATIO_TO_REPORT(CT) OVER (PARTITION BY BOOKING_IND) AS PERC
    AVG(FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)) AS AVG_CASHOUT,
    AVG(FINAL_SECURED_OFFER) AS AVG_FULL_AMT
FROM DRIVER_FINAL
WHERE 1 = 1
AND OFFER_TYPE IN ('multi offer', 'SDL', 'sec only')
AND (MTA0300 BETWEEN 1 AND 89 OR HOMEOWNER = 'H')
AND RSK_LVL <> 'D'
AND COLLAT_VALUE IS NOT NULL AND FINAL_SECURED_OFFER > 0
GROUP BY 1--, 2
ORDER BY 1--, 2
;

// HFS - AS cashout difference between people who don't book and people who do (on secured)
SELECT
    CASE WHEN ACCT_KEY > 0 THEN LOAN_TYPE ELSE 'Not Booked' END AS BOOKING_IND,
    -- CASE
    --     WHEN (FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)) - PROPOSED_OFFER_AMT > 0 THEN '1. AS Cashout is higher'       
    --     WHEN (FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)) = PROPOSED_OFFER_AMT THEN '2. $0'
    --     WHEN PROPOSED_OFFER_AMT - (FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)) <= 5000 THEN '3. $0-5K'
    --     WHEN PROPOSED_OFFER_AMT - (FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)) <= 10000 THEN '4. $5-10K'
    --     WHEN PROPOSED_OFFER_AMT - (FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)) > 10000 THEN '5. >$10K'
    --     END AS PROP_VS_BAUCO_DIFF_BKT,
    -- CASE
    --     WHEN (FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)) = 0 THEN '6. $0 Cashout'
    --     WHEN (FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)) - PROPOSED_OFFER_AMT > 0 THEN '1. AS Cashout is higher'     
    --     WHEN PROPOSED_OFFER_AMT / (FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)) = 1 THEN '2. 100%'
    --     WHEN PROPOSED_OFFER_AMT / (FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)) <= 1.3 THEN '3. 100-130%'
    --     WHEN PROPOSED_OFFER_AMT / (FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)) <= 1.5 THEN '4. 130-150%'
    --     WHEN PROPOSED_OFFER_AMT / (FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)) > 1.5 THEN '5. >150%'
    --     END AS PROP_VS_BAUCO_DIFF_BKT,
    -- CASE
    --     WHEN FINAL_SECURED_OFFER - PROPOSED_OFFER_AMT > 0 THEN '1. AS offer is higher'       
    --     WHEN FINAL_SECURED_OFFER = PROPOSED_OFFER_AMT THEN '2. $0'
    --     WHEN PROPOSED_OFFER_AMT - FINAL_SECURED_OFFER <= 5000 THEN '3. 0-5K'
    --     WHEN PROPOSED_OFFER_AMT - FINAL_SECURED_OFFER <= 10000 THEN '4. 5-10K'
    --     WHEN PROPOSED_OFFER_AMT - FINAL_SECURED_OFFER > 10000 THEN '5. >$10K'
    --     END AS PROP_VS_BAU_DIFF_BKT,
    COUNT(DISTINCT APPL_KEY) AS CT,
    --RATIO_TO_REPORT(CT) OVER (PARTITION BY BOOKING_IND) AS PERC
    --AVG(PROPOSED_OFFER_AMT - (FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE))) AS AVG_DIFF
    AVG(PROPOSED_OFFER_AMT - FINAL_SECURED_OFFER) AS AVG_DIFF
FROM (
    SELECT
        APPL_KEY, ACCT_KEY, CURRENT_OFFER, OFFER_TYPE, LOAN_TYPE, RSK_LVL, SM_SEC_OFFER, UNSEC_OFFER_AMT, FINAL_SECURED_OFFER, DEBT_VALUE, COLLAT_VALUE,
        CASE
            WHEN RSK_LVL = 'S' THEN (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER > 30000 THEN 30000 ELSE SM_SEC_OFFER END)
            WHEN RSK_LVL = 'P' THEN (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER > 25000 THEN 25000 ELSE SM_SEC_OFFER END)
            WHEN RSK_LVL = 'A' THEN (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER * 0.9 > 22500 THEN 22500 ELSE SM_SEC_OFFER * 0.9 END)
            WHEN RSK_LVL = 'B' THEN (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER * 0.85 > 15000 THEN 15000 ELSE SM_SEC_OFFER * 0.85 END)
            ELSE (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER * 0.75 > 15000 THEN 15000 ELSE SM_SEC_OFFER * 0.75 END)
            END AS PROPOSED_OFFER_AMT
    FROM DRIVER_FINAL
    WHERE 1 = 1
    AND OFFER_TYPE IN ('multi offer', 'SDL', 'sec only')
    AND (MTA0300 BETWEEN 1 AND 89 OR HOMEOWNER = 'H')
    AND RSK_LVL <> 'D'
    AND COLLAT_VALUE IS NOT NULL AND FINAL_SECURED_OFFER > 0
)
GROUP BY 1--, 2
ORDER BY 1--, 2
;

// How many of the customers with HFS - AS cashout > $5K fall into the equity<4.6K and LTV<2.7K pop? 
SELECT
    --CASE WHEN COLLAT_VALUE - ZEROIFNULL(DEBT_VALUE) < 4600 OR FINAL_SECURED_OFFER / COLLAT_VALUE < 2.7 THEN 1 ELSE 0 END AS IND,
    --CASE WHEN COLLAT_VALUE - ZEROIFNULL(DEBT_VALUE) < 5000 OR COLLAT_VALUE < 5000 THEN 1 ELSE 0 END AS IND,
    CASE WHEN COLLAT_VALUE - ZEROIFNULL(DEBT_VALUE) < 5000 THEN 1 ELSE 0 END AS LOW_EQUITY_IND,
    CASE WHEN COLLAT_VALUE < 5000 THEN 1 ELSE 0 END AS LOW_VALUE_IND,
    COUNT(DISTINCT APPL_KEY) AS CT,
    RATIO_TO_REPORT(CT) OVER () AS PERC,
    -- COUNT(DISTINCT CASE WHEN ACCT_KEY > 0 AND LOAN_TYPE = 'Secured' THEN APPL_KEY END) / CT AS PTR
FROM (
    SELECT
        APPL_KEY, ACCT_KEY, CURRENT_OFFER, OFFER_TYPE, LOAN_TYPE, RSK_LVL, SM_SEC_OFFER, UNSEC_OFFER_AMT, FINAL_SECURED_OFFER, DEBT_VALUE, COLLAT_VALUE,
        CASE
            WHEN RSK_LVL = 'S' THEN (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER > 30000 THEN 30000 ELSE SM_SEC_OFFER END)
            WHEN RSK_LVL = 'P' THEN (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER > 25000 THEN 25000 ELSE SM_SEC_OFFER END)
            WHEN RSK_LVL = 'A' THEN (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER * 0.9 > 22500 THEN 22500 ELSE SM_SEC_OFFER * 0.9 END)
            WHEN RSK_LVL = 'B' THEN (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER * 0.85 > 15000 THEN 15000 ELSE SM_SEC_OFFER * 0.85 END)
            ELSE (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER * 0.75 > 15000 THEN 15000 ELSE SM_SEC_OFFER * 0.75 END)
            END AS PROPOSED_OFFER_AMT,
        CASE
            WHEN RSK_LVL IN ('S', 'P', 'A') THEN (CASE WHEN PROPOSED_OFFER_AMT > 20000 THEN 20000 ELSE PROPOSED_OFFER_AMT END)
            WHEN RSK_LVL = 'B' THEN (CASE WHEN PROPOSED_OFFER_AMT > 15000 THEN 15000 ELSE PROPOSED_OFFER_AMT END)
            ELSE (CASE WHEN PROPOSED_OFFER_AMT > 12000 THEN 12000 ELSE PROPOSED_OFFER_AMT END)
            END AS HFS_CASHOUT
    FROM DRIVER_FINAL
    WHERE 1 = 1
    AND OFFER_TYPE IN ('multi offer', 'SDL', 'sec only')
    AND (MTA0300 BETWEEN 1 AND 89 OR HOMEOWNER = 'H')
    AND RSK_LVL <> 'D'
    AND COLLAT_VALUE IS NOT NULL AND FINAL_SECURED_OFFER > 0
    AND ACCT_KEY > 0 AND LOAN_TYPE = 'Secured'
    AND HFS_CASHOUT - (FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)) > 5000
)
GROUP BY 1, 2;
