CREATE OR REPLACE TEMPORARY TABLE CANNIBALIZATION_DRIVER AS (
    SELECT
        APPL_KEY, ACCT_KEY, OFFER_TYPE, LOAN_TYPE, RSK_LVL, FNL_RSK_GRADE_NO, VANTAGE_PRIM, CRDT_LMT_RQST_AM, FINAL_SECURED_OFFER, TRAN_DATE, APPL_ENTRY_DT, COLLAT_VALUE, DEBT_VALUE, THREAD_ACCT_KEY, APR, OWN_SCORE_BRNCH, APPLICATION_N,
        CASE
            WHEN RSK_LVL = 'S' THEN (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER > 30000 THEN 30000 ELSE SM_SEC_OFFER END)
            WHEN RSK_LVL = 'P' THEN (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER > 25000 THEN 25000 ELSE SM_SEC_OFFER END)
            WHEN RSK_LVL = 'A' THEN (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER * 0.9 > 22500 THEN 22500 ELSE SM_SEC_OFFER * 0.9 END)
            WHEN RSK_LVL = 'B' THEN (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER * 0.85 > 15000 THEN 15000 ELSE SM_SEC_OFFER * 0.85 END)
            ELSE (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER * 0.75 > 15000 THEN 15000 ELSE SM_SEC_OFFER * 0.75 END)
            END AS HFS_OFFER_AMT,
        CASE WHEN HFS_OFFER_AMT > FINAL_SECURED_OFFER THEN 1 ELSE 0 END AS HIGHER_LOAN_AMT_IND,
        CASE WHEN CRDT_LMT_RQST_AM > FINAL_SECURED_OFFER THEN 1 ELSE 0 END AS RQST_GT_APPROVED_IND,
        CASE
            WHEN OFFER_TYPE = 'sec only' OR (
                 OFFER_TYPE = 'multi offer' AND (RSK_LVL NOT IN ('S', 'P', 'A') OR 
                                                (RSK_LVL IN ('P', 'A') AND COLLAT_VALUE < 5000))
            ) THEN 'Not Impacted' ELSE 'Impacted' END AS PRICING_IMPACT_IND,
        CASE WHEN PRICING_IMPACT_IND = 'Impacted' AND COLLAT_VALUE > 15000 THEN 1 ELSE 0 END AS BETTER_PRICING_IND,
        DATEDIFF(DAY, APPL_ENTRY_DT, TRAN_DATE) AS APP_TO_CLOSE_TIME,
        CASE WHEN APP_TO_CLOSE_TIME > 7 THEN 1 ELSE 0 END AS LONG_CLOSE_TIME_IND,
        CASE WHEN (MTA0300 BETWEEN 1 AND 89 OR HOMEOWNER = 'H') THEN 1 ELSE 0 END AS HO_IND,
        CASE
            WHEN RSK_LVL IN ('S', 'P') THEN 3
            WHEN RSK_LVL = 'A' THEN 2.7
            WHEN RSK_LVL = 'B' THEN (CASE
                WHEN COLLAT_AGE < 10 THEN 2.7
                WHEN COLLAT_AGE <= 18 THEN (CASE WHEN COLLAT_VALUE < 2500 THEN 1.8 ELSE 2.7 END)
                WHEN COLLAT_AGE > 18 THEN (CASE WHEN COLLAT_VALUE <= 7000 THEN 1.8 ELSE 2.7 END)
                END)
            WHEN RSK_LVL = 'C' THEN (CASE
                WHEN COLLAT_AGE < 10 THEN (CASE WHEN COLLAT_VALUE < 2500 THEN 1.2 ELSE 1.8 END)
                WHEN COLLAT_AGE <= 18 THEN (CASE WHEN COLLAT_VALUE < 7000 THEN 1.2 ELSE 1.8 END)
                WHEN COLLAT_AGE > 18 THEN 1.2
                END)
            END AS LTV_GRID
    FROM DRIVER_FINAL
    WHERE 1 = 1
    AND OFFER_TYPE IN ('multi offer', 'SDL', 'sec only')
    AND RSK_LVL IN ('S', 'P', 'A', 'B', 'C')
    --AND COLLAT_VALUE IS NOT NULL AND FINAL_SECURED_OFFER > 0
    --AND ACCT_KEY > 0 AND LOAN_TYPE = 'Secured'
);

SELECT AVG(APP_TO_CLOSE_TIME) FROM CANNIBALIZATION_DRIVER WHERE ACCT_KEY > 0 AND LOAN_TYPE = 'Secured' AND COLLAT_VALUE IS NOT NULL AND FINAL_SECURED_OFFER > 0;


-- PTR by LTV and vehicle equity twentiles
SELECT 
    LTV_TWENTILE, MIN(LTV) AS MIN_LTV, MAX(LTV) AS MAX_LTV,
    -- LTV_GRID_TWENTILE, MIN(LTV_GRID) AS MIN_LTV_GRID, MAX(LTV_GRID) AS MAX_LTV_GRID,
    -- EQUITY_TWENTILE, MIN(EQUITY) AS MIN_EQUITY, MAX(EQUITY) AS MAX_EQUITY,
    --VALUE_TWENTILE, MIN(COLLAT_VALUE) AS MIN_VALUE, MAX(COLLAT_VALUE) AS MAX_VALUE,
    -- DEBT_TWENTILE, MIN(DEBT_VALUE) AS MIN_DEBT, MEDIAN(DEBT_VALUE) AS MED_DEBT, MAX(DEBT_VALUE) AS MAX_DEBT,
    -- AVG(FINAL_SECURED_OFFER), MIN(FINAL_SECURED_OFFER), MEDIAN(FINAL_SECURED_OFFER), MAX(FINAL_SECURED_OFFER),
    -- AVG(COLLAT_VALUE),
    COUNT(DISTINCT APPL_KEY) AS APP_CT,
    COUNT(DISTINCT CASE WHEN ACCT_KEY > 0 AND LOAN_TYPE = 'Secured' THEN APPL_KEY END) AS SEC_CT,
    SEC_CT / APP_CT AS SEC_PTR
FROM (
    SELECT *,
        FINAL_SECURED_OFFER / COLLAT_VALUE AS LTV,
        NTILE(20) OVER (ORDER BY LTV) AS LTV_TWENTILE,
        -- NTILE(20) OVER (ORDER BY LTV_GRID, FINAL_SECURED_OFFER ASC) AS LTV_GRID_TWENTILE,
        COLLAT_VALUE - ZEROIFNULL(DEBT_VALUE) AS EQUITY,
        NTILE(20) OVER (ORDER BY EQUITY) AS EQUITY_TWENTILE,
        NTILE(20) OVER (ORDER BY COLLAT_VALUE) AS VALUE_TWENTILE,
        NTILE(20) OVER (ORDER BY DEBT_VALUE) AS DEBT_TWENTILE
    FROM CANNIBALIZATION_DRIVER
    WHERE 1 = 1
    AND COLLAT_VALUE IS NOT NULL 
    AND FINAL_SECURED_OFFER > 0 
    AND HO_IND = 1
    AND HFS_OFFER_AMT > FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)
    AND OFFER_TYPE IN ('multi offer', 'SDL', 'sec only')
    AND RSK_LVL IN ('S', 'P', 'A', 'B', 'C')
) GROUP BY 1 ORDER BY 1;

-- APR impacts
SELECT 
    APR_BKT,
    SEC_AMT_BKT,
    COUNT(DISTINCT APPL_KEY) AS APP_CT, 
    COUNT(DISTINCT CASE WHEN ACCT_KEY > 0 AND LOAN_TYPE = 'Secured' THEN APPL_KEY END) AS SEC_CT,
    SEC_CT / APP_CT AS SEC_PTR,
    RATIO_TO_REPORT(APP_CT) OVER (PARTITION BY APR_BKT) AS DISTRO
FROM (
    SELECT *, 
        CASE 
            WHEN APR_RATE_P IS NULL THEN 'NULL'
            WHEN APR_RATE_P <= 15 THEN '0-15%'
            WHEN APR_RATE_P <= 20 THEN '15-20%'
            WHEN APR_RATE_P <= 25 THEN '20-25%'
            WHEN APR_RATE_P <= 30 THEN '25-30%'
            WHEN APR_RATE_P <= 35 THEN '30-35%'
            WHEN APR_RATE_P > 35 THEN '35%+'
            END AS APR_BKT,
        CASE
            WHEN FINAL_SECURED_OFFER <= 5000 THEN '1. $0-5K'
            WHEN FINAL_SECURED_OFFER <= 10000 THEN '2. $5-10K' 
            WHEN FINAL_SECURED_OFFER <= 15000 THEN '3. $10-15K' 
            WHEN FINAL_SECURED_OFFER <= 20000 THEN '4. $15-20K' 
            WHEN FINAL_SECURED_OFFER <= 25000 THEN '5. $20K-25K'
            WHEN FINAL_SECURED_OFFER > 25000 THEN '5. $25K+'
            END AS SEC_AMT_BKT,
    FROM CANNIBALIZATION_DRIVER A
    LEFT JOIN DIALER.UOPLGT00 B ON A.APPLICATION_N = B.APPLICATION_N AND A.OWN_SCORE_BRNCH = B.BRANCH_N
    WHERE 1 = 1
    AND COLLAT_VALUE IS NOT NULL AND FINAL_SECURED_OFFER > 0 AND HO_IND = 1
    --AND (HFS_OFFER_AMT <= FINAL_SECURED_OFFER OR HFS_OFFER_AMT <= CRDT_LMT_RQST_AM)
    AND B.REC_TYPE_X IN ('B', 'A')
    QUALIFY ROW_NUMBER() OVER (PARTITION BY APPL_KEY ORDER BY APR_RATE_P ASC) = 1
) GROUP BY 1, 2 ORDER BY 1, 2;

-- Waterfall v4
SELECT
    CASE 
        WHEN HO_IND = 1 AND (HFS_OFFER_AMT > FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE) AND HFS_OFFER_AMT > CRDT_LMT_RQST_AM) THEN (
            CASE
                WHEN COLLAT_VALUE < 5000 THEN '1.1 Low Vehicle Value'
                WHEN COLLAT_VALUE - ZEROIFNULL(DEBT_VALUE) < 5000 THEN '1.2 Low Equity'
                END
        )
        WHEN HO_IND = 1 AND BETTER_PRICING_IND = 1 THEN '2. Better Pricing'
        WHEN HO_IND = 1 AND LONG_CLOSE_TIME_IND = 1 THEN '3. Lower Friction'
        WHEN HO_IND = 1 THEN '4. Remaining Homeowners'
        END AS CATEGORY,
    COUNT(DISTINCT APPL_KEY) AS CT,
    RATIO_TO_REPORT(CT) OVER () AS PERC
FROM CANNIBALIZATION_DRIVER
WHERE ACCT_KEY > 0 AND LOAN_TYPE = 'Secured' AND COLLAT_VALUE IS NOT NULL AND FINAL_SECURED_OFFER > 0
GROUP BY 1
ORDER BY 1
;


-- Waterfall v3
SELECT
    CASE 
        WHEN HO_IND = 1 AND (HFS_OFFER_AMT > FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE) AND HFS_OFFER_AMT > CRDT_LMT_RQST_AM) THEN (
            CASE
                WHEN COLLAT_VALUE - ZEROIFNULL(DEBT_VALUE) < 4600 THEN '1.1 Low Equity'
                WHEN FINAL_SECURED_OFFER / COLLAT_VALUE < 2.7 THEN '1.2 Low LTV'
                --ELSE '1.3 HFS policy design' 
                END
        )
        WHEN HO_IND = 1 AND BETTER_PRICING_IND = 1 THEN '2. Better Pricing'
        WHEN HO_IND = 1 AND LONG_CLOSE_TIME_IND = 1 THEN '3. Lower Friction'
        WHEN HO_IND = 1 THEN '4. Remaining Homeowners'
        END AS CATEGORY,
    COUNT(DISTINCT APPL_KEY) AS CT,
    RATIO_TO_REPORT(CT) OVER () AS PERC
FROM CANNIBALIZATION_DRIVER
WHERE ACCT_KEY > 0 AND LOAN_TYPE = 'Secured' AND COLLAT_VALUE IS NOT NULL AND FINAL_SECURED_OFFER > 0
GROUP BY 1
ORDER BY 1
;

-- Offer size
SELECT 
    CASE
        WHEN HO_IND = 1 AND (HFS_OFFER_AMT > FINAL_SECURED_OFFER AND HFS_OFFER_AMT > CRDT_LMT_RQST_AM AND (COLLAT_VALUE - ZEROIFNULL(DEBT_VALUE) < 5000 OR COLLAT_VALUE < 5000)) THEN 1
        WHEN HO_IND = 1 AND (BETTER_PRICING_IND = 1 OR LONG_CLOSE_TIME_IND = 1) THEN 1
        ELSE 0 END AS CANNIBALIZATION_IND,
    AVG(HFS_OFFER_AMT),
    SUM(HFS_OFFER_AMT)
FROM CANNIBALIZATION_DRIVER
WHERE 1 = 1
AND OFFER_TYPE IN ('multi offer', 'SDL', 'sec only')
AND ACCT_KEY > 0 AND LOAN_TYPE = 'Secured'
AND COLLAT_VALUE IS NOT NULL AND FINAL_SECURED_OFFER > 0
GROUP BY 1
ORDER BY 1
;

-- Distros
SELECT
    -- CASE
    --     WHEN HO_IND = 1 AND (HFS_OFFER_AMT > FINAL_SECURED_OFFER AND HFS_OFFER_AMT > CRDT_LMT_RQST_AM AND (COLLAT_VALUE - ZEROIFNULL(DEBT_VALUE) < 5000 OR COLLAT_VALUE < 5000)) THEN 1
    --     WHEN HO_IND = 1 AND (BETTER_PRICING_IND = 1 OR LONG_CLOSE_TIME_IND = 1) THEN 1
    --     ELSE 0 END AS CANNIBALIZATION_IND,
    HO_IND,
    -- OFFER_TYPE,
    RSK_LVL,
    COUNT(DISTINCT APPL_KEY) AS CT,
    RATIO_TO_REPORT(CT) OVER (PARTITION BY HO_IND /*CANNIBALIZATION_IND*/) AS PERC
FROM CANNIBALIZATION_DRIVER
WHERE 1 = 1
AND RSK_LVL <> 'D'
AND OFFER_TYPE IN ('multi offer', 'SDL', 'sec only')
AND ACCT_KEY > 0 AND LOAN_TYPE = 'Secured'
AND COLLAT_VALUE IS NOT NULL AND FINAL_SECURED_OFFER > 0
GROUP BY 1, 2
ORDER BY 1, 2
;

------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------

-- 2023 Bookings Risk

CREATE OR REPLACE TEMPORARY TABLE CANNIBALIZATION_DRIVER_2023 AS (
    SELECT
        APPL_KEY, ACCT_KEY, OFFER_TYPE, LOAN_TYPE, RSK_LVL, FNL_RSK_GRADE_NO, VANTAGE_PRIM, CRDT_LMT_RQST_AM, FINAL_SECURED_OFFER, TRAN_DATE, APPL_ENTRY_DT, COLLAT_VALUE, DEBT_VALUE, THREAD_ACCT_KEY, NEW_MONEY,
        CASE
            WHEN RSK_LVL = 'S' THEN (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER > 30000 THEN 30000 ELSE SM_SEC_OFFER END)
            WHEN RSK_LVL = 'P' THEN (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER > 25000 THEN 25000 ELSE SM_SEC_OFFER END)
            WHEN RSK_LVL = 'A' THEN (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER * 0.9 > 22500 THEN 22500 ELSE SM_SEC_OFFER * 0.9 END)
            WHEN RSK_LVL = 'B' THEN (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER * 0.85 > 15000 THEN 15000 ELSE SM_SEC_OFFER * 0.85 END)
            ELSE (CASE WHEN SM_SEC_OFFER < UNSEC_OFFER_AMT THEN UNSEC_OFFER_AMT WHEN SM_SEC_OFFER * 0.75 > 15000 THEN 15000 ELSE SM_SEC_OFFER * 0.75 END)
            END AS HFS_OFFER_AMT,
        CASE WHEN HFS_OFFER_AMT > FINAL_SECURED_OFFER THEN 1 ELSE 0 END AS HIGHER_LOAN_AMT_IND,
        CASE WHEN CRDT_LMT_RQST_AM > FINAL_SECURED_OFFER THEN 1 ELSE 0 END AS RQST_GT_APPROVED_IND,
        CASE
            WHEN OFFER_TYPE = 'sec only' OR (
                 OFFER_TYPE = 'multi offer' AND (RSK_LVL NOT IN ('S', 'P', 'A') OR 
                                                (RSK_LVL IN ('P', 'A') AND COLLAT_VALUE < 5000))
            ) THEN 'Not Impacted' ELSE 'Impacted' END AS PRICING_IMPACT_IND,
        CASE WHEN PRICING_IMPACT_IND = 'Impacted' AND COLLAT_VALUE > 15000 THEN 1 ELSE 0 END AS BETTER_PRICING_IND,
        DATEDIFF(DAY, APPL_ENTRY_DT, TRAN_DATE) AS APP_TO_CLOSE_TIME,
        CASE WHEN APP_TO_CLOSE_TIME > 7 THEN 1 ELSE 0 END AS LONG_CLOSE_TIME_IND,
        CASE WHEN (MTA0300 BETWEEN 1 AND 89 OR HOMEOWNER = 'H') THEN 1 ELSE 0 END AS HO_IND
    FROM DRIVER_FINAL_2023
    WHERE 1 = 1
    AND OFFER_TYPE IN ('multi offer', 'SDL', 'sec only')
    --AND COLLAT_VALUE IS NOT NULL AND FINAL_SECURED_OFFER > 0
    --AND ACCT_KEY > 0 AND LOAN_TYPE = 'Secured'
);

CREATE OR REPLACE TEMPORARY TABLE CANNIBALIZATION_PERF_DRIVER_2023 AS (
    SELECT 
        B.*, NET_VOL, DLQ_GROUP, AMT_CHGOFF, CONSOL_NET_RECVBL_2, MOB_THREADED, MOB, ACCT_STATUS, 
        CASE
            WHEN HO_IND = 1 AND (HFS_OFFER_AMT > FINAL_SECURED_OFFER AND HFS_OFFER_AMT > CRDT_LMT_RQST_AM AND (COLLAT_VALUE - ZEROIFNULL(DEBT_VALUE) < 5000 OR COLLAT_VALUE < 5000)) THEN 1
            WHEN HO_IND = 1 AND (BETTER_PRICING_IND = 1 OR LONG_CLOSE_TIME_IND = 1) THEN 1
            ELSE 0 END AS CANNIBALIZATION_IND,
    FROM BDM.VINTAGE_PERF A
    INNER JOIN CANNIBALIZATION_DRIVER_2023 B ON A.THREAD_ACCT_KEY = B.THREAD_ACCT_KEY AND A.ORIG_CONTR_DT = B.TRAN_DATE
    WHERE 1 = 1
        AND OFFER_TYPE IN ('multi offer', 'SDL', 'sec only')
        AND LOAN_TYPE = 'Secured'
        AND COLLAT_VALUE IS NOT NULL AND FINAL_SECURED_OFFER > 0
        AND A.ORIG_CONTR_DT >= '2023-01-01'
        AND MOB_THREADED <= 24
        AND ORIG_RBO_YN = 'N' -- Refinance Balance Only (stopped doing for many years)
        AND ORIG_SDA_YN = 'N' -- Small Dollar Advance (offered to PCs who are DQ and apply for renewal)
);

SELECT
    MOB_THREADED,
    COUNT(DISTINCT CASE WHEN MOB_THREADED = 0 AND ACCT_STATUS = 'A' THEN ACCT_KEY END) AS ORIG_CT,
    SUM(ORIG_CT) OVER (ORDER BY MOB_THREADED ASC) AS ORIG_CT2,
    SUM(SUM(CASE WHEN MOB_THREADED = 0 AND ACCT_STATUS = 'A' THEN NEW_MONEY END)) OVER (ORDER BY MOB_THREADED ASC) AS ORIG_NM,
    COUNT(DISTINCT CASE WHEN CO_EVER_IND = 1 THEN ACCT_KEY END) / ORIG_CT2 AS CUMU_CO_PER_ORIG,
    SUM(CASE WHEN CO_EVER_IND = 1 THEN CO_AMT_CUMU END) / ORIG_NM AS CUMU_CO$_PER_ORIG_NM
FROM (
    SELECT
        ACCT_KEY,
        MOB_THREADED,
        ACCT_STATUS,
        HO_IND,
        RSK_LVL,
        NEW_MONEY,
        CASE WHEN DLQ_GROUP = '88' THEN 1 ELSE 0 END AS CO_IND,
        CASE WHEN SUM(CO_IND) OVER (PARTITION BY ACCT_KEY ORDER BY MOB_THREADED ASC) > 0 THEN 1 ELSE 0 END AS CO_EVER_IND,
        SUM(AMT_CHGOFF) OVER (PARTITION BY ACCT_KEY ORDER BY MOB_THREADED ASC) AS CO_AMT_CUMU
    FROM CANNIBALIZATION_PERF_DRIVER_2023
    WHERE HO_IND = 1 --CANNIBALIZATION_IND = 1
)
GROUP BY 1 ORDER BY 1;

-- normalize by swaps risk grade
WITH NORMALIZER AS (
    SELECT 
        CANNIBALIZATION_IND, 
        RSK_LVL,
        COUNT(DISTINCT CASE WHEN MOB_THREADED = 0 AND ACCT_STATUS = 'A' THEN ACCT_KEY END) AS ORIG_CT,
        ORIG_CT/SUM(ORIG_CT) OVER () AS DISTRO,
        SUM(CASE WHEN MOB_THREADED = 0 AND ACCT_STATUS = 'A' THEN NEW_MONEY END) AS ORIG_NM,
        ORIG_NM / SUM(ORIG_NM) OVER () AS DISTRO_NM
    FROM CANNIBALIZATION_PERF_DRIVER_2023
    WHERE CANNIBALIZATION_IND = 1
    GROUP BY 1, 2
),
RISK AS (
    SELECT
        HO_IND, --CANNIBALIZATION_IND,
        RSK_LVL,
        MOB_THREADED,
        COUNT(DISTINCT CASE WHEN MOB_THREADED = 0 AND ACCT_STATUS = 'A' THEN ACCT_KEY END) AS ORIG_CT,
        SUM(ORIG_CT) OVER (PARTITION BY HO_IND /*CANNIBALIZATION_IND*/, RSK_LVL ORDER BY MOB_THREADED ASC) AS ORIG_CT2,
        SUM(SUM(CASE WHEN MOB_THREADED = 0 AND ACCT_STATUS = 'A' THEN NEW_MONEY END)) OVER (PARTITION BY HO_IND /*CANNIBALIZATION_IND*/, RSK_LVL ORDER BY MOB_THREADED ASC) AS ORIG_NM,
        COUNT(DISTINCT CASE WHEN CO_EVER_IND = 1 THEN ACCT_KEY END) / ORIG_CT2 AS CUMU_CO_PER_ORIG,
        SUM(CASE WHEN CO_EVER_IND = 1 THEN CO_AMT_CUMU END) / ORIG_NM AS CUMU_CO$_PER_ORIG_NM
    FROM (
        SELECT
            ACCT_KEY,
            MOB_THREADED,
            ACCT_STATUS,
            CANNIBALIZATION_IND,
            HO_IND,
            RSK_LVL,
            NEW_MONEY,
            CASE WHEN DLQ_GROUP = '88' THEN 1 ELSE 0 END AS CO_IND,
            CASE WHEN SUM(CO_IND) OVER (PARTITION BY ACCT_KEY ORDER BY MOB_THREADED ASC) > 0 THEN 1 ELSE 0 END AS CO_EVER_IND,
            SUM(AMT_CHGOFF) OVER (PARTITION BY ACCT_KEY ORDER BY MOB_THREADED ASC) AS CO_AMT_CUMU
        FROM CANNIBALIZATION_PERF_DRIVER_2023
    ) 
    GROUP BY 1, 2, 3 
    ORDER BY 1, 2, 3
)
SELECT /*A.CANNIBALIZATION_IND,*/ MOB_THREADED, SUM(CUMU_CO_PER_ORIG * DISTRO) / SUM(DISTRO) AS CO_PER_ORIG_NORMALIZED, SUM(CUMU_CO$_PER_ORIG_NM * DISTRO_NM) / SUM(DISTRO_NM) AS CUMU_CO$_PER_ORIG_NM_NORMALIZED
FROM RISK A
LEFT JOIN NORMALIZER B ON A.RSK_LVL = B.RSK_LVL
WHERE HO_IND = 1
GROUP BY 1--, 2
ORDER BY 1--, 2
;
