-------------
-- PRICING --
-------------

-- % of apps in segments not eligible for additional pricing discounts for secured
SELECT
    CASE
        WHEN OFFER_TYPE = 'sec only' OR (
             OFFER_TYPE = 'multi offer' AND (RSK_LVL NOT IN ('S', 'P', 'A') OR 
                                            (RSK_LVL IN ('P', 'A') AND COLLAT_VALUE < 5000))
        ) THEN 'Not Impacted' ELSE 'Impacted' END AS PRICING_IMPACT_IND,
    COUNT(DISTINCT APPL_KEY) AS APP_CT,
    RATIO_TO_REPORT(APP_CT) OVER () AS PERC
FROM DRIVER_FINAL
WHERE 1 = 1
AND OFFER_TYPE IN ('multi offer', 'SDL', 'sec only')
AND (MTA0300 BETWEEN 1 AND 89 OR HOMEOWNER = 'H')
AND COLLAT_VALUE IS NOT NULL
AND FINAL_SECURED_OFFER > 0
GROUP BY 1;

-- BAU distros (lowest offer)
SELECT
    CASE 
        WHEN APR_RATE_P IS NULL THEN 'NULL'
        WHEN APR_RATE_P <= 15 THEN '0-15%'
        WHEN APR_RATE_P <= 20 THEN '15-20%'
        WHEN APR_RATE_P <= 25 THEN '20-25%'
        WHEN APR_RATE_P <= 30 THEN '25-30%'
        WHEN APR_RATE_P <= 35 THEN '30-35%'
        WHEN APR_RATE_P > 35 THEN '35%+'
        END AS APR_BKT,
    COUNT(DISTINCT APPL_KEY) AS APP_CT,
    RATIO_TO_REPORT(APP_CT) OVER () AS PERC,
    AVG(APR_RATE_P) AS AVG_APR
FROM (
    SELECT A.*, APR_RATE_P
    FROM DRIVER_FINAL A
    LEFT JOIN DIALER.UOPLGT00 B ON A.APPLICATION_N = B.APPLICATION_N AND A.OWN_SCORE_BRNCH = B.BRANCH_N
    WHERE B.REC_TYPE_X IN ('B', 'A')
    QUALIFY ROW_NUMBER() OVER (PARTITION BY APPL_KEY ORDER BY APR_RATE_P ASC) = 1
)
WHERE 1 = 1
AND OFFER_TYPE IN ('multi offer', 'SDL', 'sec only')
AND (MTA0300 BETWEEN 1 AND 89 OR HOMEOWNER = 'H')
AND COLLAT_VALUE IS NOT NULL
GROUP BY 1
ORDER BY 1
;

-- Check APR distros at different collateral value levels
SELECT
    CASE
        WHEN OFFER_TYPE = 'sec only' OR (
             OFFER_TYPE = 'multi offer' AND (RSK_LVL NOT IN ('S', 'P', 'A') OR 
                                            (RSK_LVL IN ('P', 'A') AND COLLAT_VALUE < 5000))
        ) THEN 'Not Impacted' ELSE 'Impacted' END AS PRICING_IMPACT_IND,
    CASE 
        WHEN APR_RATE_P IS NULL THEN 'NULL'
        WHEN APR_RATE_P <= 15 THEN '0-15%'
        WHEN APR_RATE_P <= 20 THEN '15-20%'
        WHEN APR_RATE_P <= 25 THEN '20-25%'
        WHEN APR_RATE_P <= 30 THEN '25-30%'
        WHEN APR_RATE_P <= 35 THEN '30-35%'
        WHEN APR_RATE_P > 35 THEN '35%+'
        END AS APR_BKT,
    COUNT(DISTINCT APPL_KEY) AS APP_CT,
    RATIO_TO_REPORT(APP_CT) OVER (PARTITION BY  APR_BKT
                                                --PRICING_IMPACT_IND
                                                ) AS PERC,
    AVG(APR_RATE_P) AS AVG_APR
FROM (
    SELECT A.*, APR_RATE_P
    FROM DRIVER_FINAL A
    LEFT JOIN DIALER.UOPLGT00 B ON A.APPLICATION_N = B.APPLICATION_N AND A.OWN_SCORE_BRNCH = B.BRANCH_N
    WHERE B.REC_TYPE_X IN ('B', 'A')
    QUALIFY ROW_NUMBER() OVER (PARTITION BY APPL_KEY ORDER BY APR_RATE_P ASC) = 1
)
WHERE 1 = 1
AND OFFER_TYPE IN ('multi offer', 'SDL', 'sec only')
AND (MTA0300 BETWEEN 1 AND 89 OR HOMEOWNER = 'H')
-- AND COLLAT_VALUE BETWEEN 9500 AND 10500
--AND BRANCH_ST IN ('WI', 'MO')
GROUP BY 1, 2--, 3
ORDER BY 1, 2--, 3
;
-- HFS overall avg. APR
SELECT 28.93341698 * (1873/(1873+4866)) + 24.36328607 * (4866/(1873+4866));


------------
-- VOLUME --
------------

-- Two populations: 1) convert x% of people who would have walked away and 2) people who book unsecured today that we expect to convert to home fixture secured

// Volume waterfalls
SELECT
    --VEHICLE_PRESENT,
    --OFFER_TYPE, 
    COUNT(DISTINCT APPL_KEY) * 2 AS OFFER_CT,
    COUNT(DISTINCT CASE WHEN CATEGORY = 'BOOKED' THEN APPL_KEY END) * 2 AS BOOKED,
    COUNT(DISTINCT CASE WHEN CATEGORY = 'RQST GT CAP' THEN APPL_KEY END) * 2 AS RQST_GT_CAP,
    COUNT(DISTINCT CASE WHEN CATEGORY = 'MET RQST AMT' THEN APPL_KEY END) * 2 AS MET_RQST_AMT,
    COUNT(DISTINCT CASE WHEN CATEGORY = 'NON HO' THEN APPL_KEY END) * 2 AS NON_HO,
    COUNT(DISTINCT CASE WHEN CATEGORY = 'WITH VEHICLE INFO' THEN APPL_KEY END) * 2 AS VEHICLE_PROVIDE,
    -- OFFER_CT - BOOKED - RQST_GT_CAP - MET_RQST_AMT - NON_HO - VEHICLE_PROVIDE AS TARGET_CT,
    -- COUNT(DISTINCT CASE WHEN CATEGORY IS NULL THEN APPL_KEY END) * 2 AS TARGET_CT
FROM (
    SELECT
        APPL_KEY,
        OFFER_TYPE,
        --CASE WHEN COLLAT_VALUE IS NULL THEN 0 ELSE 1 END AS VEHICLE_PRESENT,
        CASE
            WHEN ACCT_KEY > 0 THEN 'BOOKED'
            WHEN (RSK_LVL IN ('S', 'P', 'A' ) AND CRDT_LMT_RQST_AM > 20000) OR (RSK_LVL = 'B' AND CRDT_LMT_RQST_AM > 15000) OR (RSK_LVL = 'C' AND CRDT_LMT_RQST_AM > 12000) THEN 'RQST GT CAP'
            WHEN CRDT_LMT_RQST_AM <= (FINAL_SECURED_OFFER - ZEROIFNULL(DEBT_VALUE)) OR CRDT_LMT_RQST_AM <= UNSEC_OFFER_AMT THEN 'MET RQST AMT'
            WHEN MTA0300 NOT BETWEEN 1 AND 89 AND HOMEOWNER <> 'H' THEN 'NON HO'
            WHEN COLLAT_VALUE IS NOT NULL THEN 'WITH VEHICLE INFO'
            END AS CATEGORY
    FROM DRIVER_FINAL
    WHERE OFFER_TYPE IN ('multi offer', 'SDL', 'sec only')
) 
--GROUP BY 1--, 2 
--ORDER BY 1--, 2
;

SELECT
    --CURRENT_OFFER,
    OFFER_TYPE,
    COUNT(DISTINCT APPL_KEY) * 2 AS BOOKING_CT,
    --COUNT(DISTINCT CASE WHEN CATEGORY = 'BOOKED ON SEC' THEN APPL_KEY END) * 2 AS BOOKED_ON_SEC,
    COUNT(DISTINCT CASE WHEN CATEGORY = 'UNSEC <= CO SEC' THEN APPL_KEY END) * 2 AS UNSEC_LT_COSEC,
    COUNT(DISTINCT CASE WHEN CATEGORY = 'NON HO' THEN APPL_KEY END) * 2 AS NON_HO,
    --BOOKING_CT - BOOKED_ON_SEC - UNSEC_LT_COSEC - NON_HO AS TARGET_CT,
    COUNT(DISTINCT CASE WHEN CATEGORY IS NULL THEN APPL_KEY END) * 2 AS TARGET_CT
FROM (
    SELECT
        APPL_KEY,
        OFFER_TYPE,
        CURRENT_OFFER,
        CASE 
            --WHEN LOAN_TYPE = 'Secured' THEN 'BOOKED ON SEC'
            WHEN UNSEC_OFFER_AMT <= (ZEROIFNULL(FINAL_SECURED_OFFER) - ZEROIFNULL(DEBT_VALUE)) THEN 'UNSEC <= CO SEC'
            WHEN MTA0300 NOT BETWEEN 1 AND 89 AND HOMEOWNER <> 'H' THEN 'NON HO'
            END AS CATEGORY
    FROM DRIVER_FINAL
    WHERE OFFER_TYPE IN ('multi offer', 'SDL') AND LOAN_TYPE = 'Unsecured'
    --CURRENT_OFFER IN ('MO', 'SDL')
    AND ACCT_KEY > 0
) GROUP BY 1;


// Volume by RD
-- Pop 1
SELECT
    RD_NM_CLEANED,
    BRANCH_ST,
    -- BRANCH_NM,
    -- COUNT(DISTINCT APPL_KEY) / 6 AS MONTHLY_TARGET,
    COUNT(DISTINCT APPL_KEY) / 6 * 0.05 AS MONTHLY_INCR_LOANS,
    -- COUNT(DISTINCT CASE WHEN EFILE_IND = 1 THEN APPL_KEY END) / 6 * 0.05 AS MONTHLY_INCR_EFILE_LOANS,
    -- MONTHLY_INCR_EFILE_LOANS / MONTHLY_INCR_LOANS AS EFILE_RATE,
    -- COUNT(DISTINCT BRANCH_NM) AS BRANCH_CT,
FROM DRIVER_FINAL
WHERE 1 = 1
AND OFFER_TYPE IN ('sec only', 'SDL', 'multi offer') -- approved
AND ACCT_KEY = 0 -- but did not book
AND NOT ((RSK_LVL IN ('S', 'P', 'A' ) AND CRDT_LMT_RQST_AM > 20000) OR (RSK_LVL = 'B' AND CRDT_LMT_RQST_AM > 15000) OR (RSK_LVL = 'C' AND CRDT_LMT_RQST_AM > 12000)) -- request < cap
AND CRDT_LMT_RQST_AM > (ZEROIFNULL(FINAL_SECURED_OFFER) - ZEROIFNULL(DEBT_VALUE)) AND CRDT_LMT_RQST_AM > UNSEC_OFFER_AMT -- request amount not met
AND (MTA0300 BETWEEN 1 AND 89 OR HOMEOWNER = 'H') -- homeowners
AND RD_NM_CLEANED ILIKE ANY ('%SHANNON%', '%XAVIER%', '%JERRY%', '%TED%', '%MARY%')
-- AND BRANCH_ST IN ('WI', 'MO')
GROUP BY 1, 2
ORDER BY 1, 2
;

-- Pop 2
SELECT 
    RD_NM_CLEANED,
    --BRANCH_ST,
    --BRANCH_NM,
    COUNT(DISTINCT CASE WHEN OFFER_TYPE = 'multi offer' THEN APPL_KEY END) / 6 AS MONTHLY_TARGET_MO,
    COUNT(DISTINCT CASE WHEN OFFER_TYPE = 'SDL' THEN APPL_KEY END) / 6 AS MONTHLY_TARGET_SDL,
    MONTHLY_TARGET_MO * 0.19 AS MONTHLY_MO_CANN,
    MONTHLY_TARGET_SDL * 0.27 AS MONTHLY_SDL_CANN,
    MONTHLY_MO_CANN + MONTHLY_SDL_CANN AS TOTAL_UNSEC_CANN
FROM DRIVER_FINAL
WHERE 1 = 1
AND ACCT_KEY > 0 AND OFFER_TYPE IN ('multi offer', 'SDL') AND LOAN_TYPE = 'Unsecured'  -- booked on unsecured
AND UNSEC_OFFER_AMT > (ZEROIFNULL(FINAL_SECURED_OFFER) - ZEROIFNULL(DEBT_VALUE)) -- unsec offer amt > cashout sec offer amt
AND (MTA0300 BETWEEN 1 AND 89 OR HOMEOWNER = 'H') -- homeowners 
AND FINAL_SECURED_OFFER > 0
-- AND RD_NM_CLEANED ILIKE ANY ('%SHANNON%', '%XAVIER%', '%JERRY%', '%TED%', '%MARY%')
--AND BRANCH_ST IN ('WI', 'MO')
GROUP BY 1--, 2
ORDER BY 1--, 2
;

SELECT 
    --RD_NM_CLEANED, 
    BRANCH_ST, --BRANCH_NM, 
    COUNT(DISTINCT APPL_KEY) AS APP_CT,
    COUNT(DISTINCT CASE WHEN LOAN_TYPE = 'Secured' THEN ACCT_KEY END ) / 6 AS SEC_ACCT_CT, 
    COUNT(DISTINCT CASE WHEN LOAN_TYPE = 'Unsecured' THEN ACCT_KEY END ) / 6 AS UNSEC_ACCT_CT,
    COUNT(DISTINCT BRANCH_NM) AS BRANCH_CT
FROM DRIVER_FINAL
WHERE 1 = 1
--AND BRANCH_ST IN ('WI', 'MO')
AND RD_NM_CLEANED ILIKE ANY ('%SHANNON%', '%XAVIER%', '%JERRY%', '%TED%', '%MARY%')
AND OFFER_TYPE IN ('SDL', 'multi offer', 'sec only')
--AND ACCT_KEY > 0
GROUP BY 1--, 2
ORDER BY 1--, 2
;

SELECT 
    COUNT(DISTINCT CASE WHEN RD_NM_CLEANED ILIKE ANY ('%SHANNON%', '%XAVIER%'
    , '%JERRY%', '%TED%', '%MARY%'
    ) THEN BRANCH_NM END) AS INCLUDE_CT,
    COUNT(DISTINCT BRANCH_NM) AS TOTAL_CT,
    INCLUDE_CT / TOTAL_CT AS NETWORK_RATE
FROM DRIVER_FINAL
;

SELECT 
    RD_NM_CLEANED, --BRANCH_ST, --BRANCH_NM, 
    COUNT(DISTINCT CASE WHEN LOAN_TYPE = 'Secured' THEN ACCT_KEY END ) / 6 AS SEC_ACCT_CT, 
    COUNT(DISTINCT CASE WHEN LOAN_TYPE = 'Unsecured' THEN ACCT_KEY END ) / 6 AS UNSEC_ACCT_CT,
    COUNT(DISTINCT BRANCH_NM) AS BRANCH_CT
FROM DRIVER_FINAL
WHERE 1 = 1
--AND BRANCH_ST IN ('WI', 'MO')
AND RD_NM_CLEANED ILIKE ANY ('%SHANNON%', '%XAVIER%', '%JERRY%', '%TED%', '%MARY%')
AND OFFER_TYPE IN ('SDL', 'multi offer', 'sec only')
AND ACCT_KEY > 0
GROUP BY 1--, 2
ORDER BY 1--, 2
;

--------------------------------------------------------------------------------

// General apps volume
SELECT 
    RD_NM_CLEANED,
    --BRANCH_NM,
    --COUNT(DISTINCT APPL_KEY) / 6 AS MONTHLY_APPROVED_APPS,
    --COUNT(DISTINCT CASE WHEN ACCT_KEY > 0 THEN APPL_KEY END) / 6 AS MONTHLY_BOOKINGS,
    COUNT(DISTINCT CASE WHEN EFILE_IND = 1 THEN APPL_KEY END) / COUNT(DISTINCT APPL_KEY) AS EFILE_RATE, 
    --COUNT(DISTINCT CASE WHEN MTA0300 BETWEEN 1 AND 89 OR HOMEOWNER = 'H' THEN APPL_KEY END) / 6 AS MONTHLY_APPROVED_HO_APPS,
    COUNT(DISTINCT CASE WHEN MTA0300 BETWEEN 1 AND 89 OR HOMEOWNER = 'H' THEN APPL_KEY END) / COUNT(DISTINCT APPL_KEY) AS HO_RATE
FROM DRIVER_FINAL
WHERE 1 = 1
AND OFFER_TYPE IN ('SDL', 'multi offer', 'sec only')
GROUP BY 1
ORDER BY 1
;

SELECT RD_NM, COUNT(DISTINCT APPL_KEY) AS APPS, COUNT(DISTINCT CASE WHEN MTA0300 BETWEEN 1 AND 89 OR HOMEOWNER = 'H' THEN APPL_KEY END) AS HO_APPS
FROM DRIVER_FINAL
GROUP BY 1 ORDER BY 3 ASC;

-- % of app volume from CPS
SELECT CASE WHEN BRANCH_ST IN ('AZ','CA','ID','LA','NV','NM','TX','WA','WI') THEN 1 ELSE 0 END AS CPS_IND, COUNT(DISTINCT APPL_KEY) AS APP_CT, RATIO_TO_REPORT(APP_CT) OVER () AS PERC
FROM DRIVER_FINAL
WHERE 1 = 1
AND OFFER_TYPE IN ('SDL', 'multi offer', 'sec only')
AND (MTA0300 BETWEEN 1 AND 89 OR HOMEOWNER = 'H')
GROUP BY 1;

-- Auto Sec Booking Volume
SELECT COUNT(DISTINCT ACCT_KEY) / 6 * 12 AS ANNUALIZED_AS_ACCT_CT
FROM DRIVER_FINAL
WHERE OFFER_TYPE IN ('multi offer', 'SDL', 'sec only')
AND LOAN_TYPE = 'Secured'
AND ACCT_KEY > 0
;

-- HO distros by offer type
SELECT 
    OFFER_TYPE,
    CASE WHEN (MTA0300 BETWEEN 1 AND 89 OR HOMEOWNER = 'H') THEN 1 ELSE 0 END AS HO_IND, 
    COUNT(DISTINCT APPL_KEY) AS APP_CT, 
    RATIO_TO_REPORT(APP_CT) OVER (PARTITION BY OFFER_TYPE) AS PERC
FROM DRIVER_FINAL
WHERE OFFER_TYPE IN ('multi offer', 'SDL', 'sec only')
GROUP BY 1, 2
ORDER BY 1, 2
;

-- BAU PTR
SELECT
    COUNT(DISTINCT CASE WHEN ACCT_KEY > 0 AND LOAN_TYPE = 'Secured' THEN APPL_KEY END) AS SEC_CT,
    COUNT(DISTINCT CASE WHEN ACCT_KEY > 0 AND LOAN_TYPE = 'Unsecured' THEN APPL_KEY END) AS UNS_CT,
    COUNT(DISTINCT APPL_KEY) AS APP_CT,
    SEC_CT / APP_CT AS SEC_PTR,
    UNS_CT / APP_CT AS UNS_PTR
FROM DRIVER_FINAL
WHERE OFFER_TYPE IN ('multi offer', 'SDL', 'sec only');


--------------------
-- CONTROL STATES --
--------------------

// MO vs. Ohio / Kansas
// WI vs. MI / Indiana

-- NCFC Mix
-- MO/SDL/SO Distribution
-- Secured PTR

-- Demographics
SELECT
    BRANCH_ST,
    -- OFFER_TYPE,
    -- CUST_TYPE,
    RSK_LVL,
    -- CASE
    --     WHEN VANTAGE_PRIM IS NULL THEN 'NULL'
    --     WHEN VANTAGE_PRIM <= 600 THEN '<=600'
    --     WHEN VANTAGE_PRIM <= 660 THEN '600-660'
    --     WHEN VANTAGE_PRIM <= 780 THEN '660-780'
    --     WHEN VANTAGE_PRIM <= 850 THEN '780+'
    --     ELSE 'NULL'
    --     END AS FICO_BKT,
    COUNT(DISTINCT APPL_KEY) AS APP_CT,
    RATIO_TO_REPORT(APP_CT) OVER (PARTITION BY BRANCH_ST) AS PERC
FROM BDM.APP_LOAN_PRODUCTION
WHERE 1 = 1
AND APPL_ENTRY_DT BETWEEN '2025-01-01' AND '2025-06-30'
AND ACAP_REFR_ID IS NOT NULL 
AND APPL_KEY IS NOT NULL
AND CORE_V_CAPP = 'Core' 
AND CUST_TYPE IN ('NC', 'FC')
AND OFFER_TYPE IN ('multi offer', 'SDL', 'sec only') 
AND BRANCH_ST IN ('MO', 'WI', 'MI', 'KS', 'OH', 'IN')
--AND HOMEOWNER = 'H'
GROUP BY 1, 2
ORDER BY 1, 2
;

-- Secured PTR
SELECT
    BRANCH_ST,
    OFFER_TYPE,
    COUNT(DISTINCT APPL_KEY) AS APP_CT,
    COUNT(DISTINCT CASE WHEN ACCT_KEY > 0 THEN APPL_KEY END) AS ACCT_CT,
    COUNT(DISTINCT CASE WHEN ACCT_KEY > 0 AND LOAN_PROD_CD_PLR IN ('A1','P1','A2','P2','A3','P3','A4','P4','P5','P6','PP','PS') THEN APPL_KEY END) AS SEC_ACCT_CT,
    ACCT_CT / APP_CT AS PTR_ALL,
    SEC_ACCT_CT / APP_CT AS PTR_SEC
FROM BDM.APP_LOAN_PRODUCTION
WHERE 1 = 1
AND APPL_ENTRY_DT BETWEEN '2025-01-01' AND '2025-06-30'
AND ACAP_REFR_ID IS NOT NULL 
AND APPL_KEY IS NOT NULL
AND CORE_V_CAPP = 'Core' 
AND CUST_TYPE IN ('NC', 'FC')
AND OFFER_TYPE IN ('multi offer', 'SDL', 'sec only') 
AND BRANCH_ST IN ('MO', 'WI', 'MI', 'KS', 'OH', 'IN')
GROUP BY 1, 2
ORDER BY 1, 2
;



--------------------------------------------------------------------------------

-----------------
-- PERFORMANCE --
-----------------

CREATE OR REPLACE TEMPORARY TABLE PERF_DRIVER AS (
    SELECT APPL_KEY, ACAP_REFR_ID, ACCT_KEY, B.THREAD_ACCT_KEY, B.TRAN_DATE, APPLICATION_N, OWN_SCORE_BRNCH, B.RSK_LVL, B.HOMEOWNER, OFFER_TYPE, CRDT_LMT_RQST_AM, SEC_OFFER_AMT, UNSEC_OFFER_AMT, AMOUNT_M, B.APR, RD_NM, BRANCH_ZIP, BRANCH_ST, BRANCH_NM, DLQ_GROUP, MOB_THREADED, MOB, ACCT_STATUS, CASE WHEN LOAN_PROD_CD_PLR = 'PU' THEN 'Unsecured' ELSE 'Secured' END AS LOAN_TYPE
    FROM BDM.VINTAGE_PERF A
    INNER JOIN BDM.APP_LOAN_PRODUCTION B ON A.THREAD_ACCT_KEY = B.THREAD_ACCT_KEY AND A.ORIG_CONTR_DT = B.TRAN_DATE
    WHERE 1 = 1
        AND APPL_ENTRY_DT BETWEEN '2023-01-01' AND '2023-12-31'
        AND ACAP_REFR_ID IS NOT NULL 
        AND APPL_KEY IS NOT NULL
        AND ACCT_KEY > 0 
        AND CORE_V_CAPP = 'Core' 
        AND B.CUST_TYPE IN ('NC', 'FC')
        AND OFFER_TYPE IN ('multi offer', 'SDL', 'sec only')
        AND LOAN_PROD_CD_PLR IN ('A1','P1','A2','P2','A3','P3','A4','P4','P5','P6','PP','PS', 'PU') 
        AND A.ORIG_CONTR_DT >= '2023-01-01'
        AND MOB_THREADED <= 24
        AND ORIG_RBO_YN = 'N' -- Refinance Balance Only (stopped doing for many years)
        AND ORIG_SDA_YN = 'N' -- Small Dollar Advance (offered to PCs who are DQ and apply for renewal)
);

-- DQs & charge-offs (raw)
SELECT
    --RSK_LVL,
    --HOMEOWNER,
    MOB_THREADED,
    COUNT(DISTINCT CASE WHEN MOB_THREADED = 0 AND ACCT_STATUS = 'A' THEN ACCT_KEY END) AS ORIG_CT,
    SUM(ORIG_CT) OVER (/*PARTITION BY RSK_LVL, HOMEOWNER*/ ORDER BY MOB_THREADED ASC) AS ORIG_CT2,
    COUNT(DISTINCT CASE WHEN ACCT_STATUS = 'A' THEN ACCT_KEY END) AS OPEN_CT,
    COUNT(DISTINCT CASE WHEN DQ30PLUS_IND = 1 THEN ACCT_KEY END) / NULLIFZERO(OPEN_CT) AS DQ30PLUS_PER_OPEN,
    COUNT(DISTINCT CASE WHEN DQ30PLUS_EVER_IND = 1 THEN ACCT_KEY END) / NULLIFZERO(ORIG_CT2) AS CUMU_DQ30PLUS_PER_ORIG,
    COUNT(DISTINCT CASE WHEN CO_EVER_IND = 1 THEN ACCT_KEY END) / NULLIFZERO(ORIG_CT2) AS CUMU_CO_PER_ORIG
FROM (
    SELECT
        ACCT_KEY,
        RSK_LVL,
        MOB_THREADED,
        ACCT_STATUS,
        HOMEOWNER,
        CASE WHEN DLQ_GROUP IN ('2','3','4','5','6','7','8+') THEN 1 ELSE 0 END AS DQ30PLUS_IND,
        CASE WHEN SUM(DQ30PLUS_IND) OVER (PARTITION BY ACCT_KEY ORDER BY MOB_THREADED ASC) > 0 THEN 1 ELSE 0 END AS DQ30PLUS_EVER_IND,
        CASE WHEN DLQ_GROUP = '88' THEN 1 ELSE 0 END AS CO_IND,
        CASE WHEN SUM(CO_IND) OVER (PARTITION BY ACCT_KEY ORDER BY MOB_THREADED ASC) > 0 THEN 1 ELSE 0 END AS CO_EVER_IND
    FROM PERF_DRIVER
    WHERE LOAN_TYPE = 'Secured'
) 
GROUP BY 1--, 2--, 3 
ORDER BY 1--, 2--, 3
;

-- % of accts DQ30+ that also CO
SELECT DQ30PLUS_BY6, CO_BY18, COUNT(DISTINCT ACCT_KEY) AS CT, RATIO_TO_REPORT(CT) OVER () AS PERC FROM (
    SELECT
        ACCT_KEY,
        MAX(CASE WHEN MOB_THREADED <= 6 AND DQ30PLUS_EVER_IND = 1 THEN 1 ELSE 0 END) AS DQ30PLUS_BY6,
        MAX(CASE WHEN MOB_THREADED <= 18 AND CO_EVER_IND = 1 THEN 1 ELSE 0 END) AS CO_BY18
    FROM (
        SELECT
            ACCT_KEY,
            RSK_LVL,
            MOB_THREADED,
            ACCT_STATUS,
            HOMEOWNER,
            CASE WHEN DLQ_GROUP IN ('2','3','4','5','6','7','8+') THEN 1 ELSE 0 END AS DQ30PLUS_IND,
            CASE WHEN SUM(DQ30PLUS_IND) OVER (PARTITION BY ACCT_KEY ORDER BY MOB_THREADED ASC) > 0 THEN 1 ELSE 0 END AS DQ30PLUS_EVER_IND,
            CASE WHEN DLQ_GROUP = '88' THEN 1 ELSE 0 END AS CO_IND,
            CASE WHEN SUM(CO_IND) OVER (PARTITION BY ACCT_KEY ORDER BY MOB_THREADED ASC) > 0 THEN 1 ELSE 0 END AS CO_EVER_IND
        FROM PERF_DRIVER
        WHERE LOAN_TYPE = 'Secured'
    ) GROUP BY 1
) GROUP BY 1, 2
HAVING DQ30PLUS_BY6 = 1
;


-- Auto sec risk: homeowners vs. non-homeowners; normalized by homeowners risk grade
WITH NORMALIZER AS (
    SELECT 
        HOMEOWNER, 
        RSK_LVL,
        COUNT(DISTINCT CASE WHEN MOB_THREADED = 0 AND ACCT_STATUS = 'A' THEN ACCT_KEY END) AS ORIG_CT,
        ORIG_CT/SUM(ORIG_CT) OVER () AS DISTRO
    FROM AUTO_SEC_PERF_DRIVER
    WHERE HOMEOWNER = 'H' AND LOAN_TYPE = 'Secured'
    GROUP BY 1, 2
),
RISK AS (
    SELECT
        HOMEOWNER,
        RSK_LVL,
        MOB_THREADED,
        COUNT(DISTINCT CASE WHEN MOB_THREADED = 0 AND ACCT_STATUS = 'A' THEN ACCT_KEY END) AS ORIG_CT,
        SUM(ORIG_CT) OVER (PARTITION BY HOMEOWNER, RSK_LVL ORDER BY MOB_THREADED ASC) AS ORIG_CT2,
        COUNT(DISTINCT CASE WHEN CO_EVER_IND = 1 THEN ACCT_KEY END) / ORIG_CT2 AS CUMU_CO_PER_ORIG
    FROM (
        SELECT
            ACCT_KEY,
            MOB_THREADED,
            ACCT_STATUS,
            HOMEOWNER,
            RSK_LVL,
            CASE WHEN DLQ_GROUP = '88' THEN 1 ELSE 0 END AS CO_IND,
            CASE WHEN SUM(CO_IND) OVER (PARTITION BY ACCT_KEY ORDER BY MOB_THREADED ASC) > 0 THEN 1 ELSE 0 END AS CO_EVER_IND
        FROM PERF_DRIVER
        WHERE LOAN_TYPE = 'Secured'
    ) 
    GROUP BY 1, 2, 3
)
SELECT A.HOMEOWNER, MOB_THREADED, SUM(CUMU_CO_PER_ORIG * DISTRO) / SUM(DISTRO) AS CO_PER_ORIG_NORMALIZED
FROM RISK A
LEFT JOIN NORMALIZER B ON A.RSK_LVL = B.RSK_LVL
GROUP BY 1, 2
ORDER BY 1, 2;
